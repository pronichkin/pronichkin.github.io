<!DOCTYPE html>
<html>
<head>
    <style>
        * {
            font-family: Calibri,Candara,Segoe,Segoe UI,Optima,Arial,sans-serif;
        }
    </style>
</head>
<body>
    <h1>Tools manifesto</h1>
    <p>version 2019-08-14 by <a href="/">Artem Pronichkin</a></p>
    <h2>TL;DR</h2>
    <p>
        The below requirements are based on my experience working with several
        security-cautions customers, such as banks or government agencies across
        the world.
    </p>
    <h2>The problem with today's tools</h2>
    <p>
        When supporting customers or working with commercial support organizations
        on behalf of customers, it's quite common to be asked for running a
        certain tool to troubleshoot or gather logs. It sounds very easy for
        support people, and hence they tend to &ldquo;overrequest
        &rdquo;&mdash;that is, ask for using more tools than needed at certain point.
    </p>
    <p>
        Unfortunately, not all tools are created equal, and some of them might be
        difficult to run in certain environment&mdash;especially when it's fairly
        locked down. While certainly possible, request
        to run such tools might delay troubleshooting significantly, because it
        would require to change production system configuration (e.g. include
        specific binary into whitelisting policy.) Hence, we should avoid such
        tools (that is, the tools which fail to comply with the requirements
        provided below)&mdash;unless absolutely necessary and reasonable to proceed.
    </p>
    <p>
        I'm not saying that each and every customer would impose the constraints
        listed below. In fact, most of the customers would not, or maybe they
        will have only one or two of these requirements. However, the list below
        is meant to be comprehensive and failsafe&mdash;that is, if you succeed
        to comply with all of these requirements, you can be confident your tool
        won't face any obstacles and can be recommended for broad use.
    </p>
    <h2>Scope of the problem</h2>
    <p>
        These requirements are not specific to troubleshooting
        or diagnostic tools. I mention those types of tools first because I have
        personally been bitten by this before many times. When you have a
        time-sensitive problem and call for support, the last thing you want is
        to be asked for running a tool which fails to execute. So that instead
        of troubleshooting the actual problem, you start troubleshooting the
        tool. And this might require changes to production servers which are
        often not easy (either technically or operationally), or might impact
        the repro.
    </p>
    <p>        
        However, the below requirements are
        in fact universal and can (or even should) be applied to any tools or
        utilities that
        we, as an industry, expect customers to run&mdash;such as monitoring,
        hardware configuration,
        audit assessment, system deployment and configuration, etc.
    </p>
    <hr />
    <h2>1. Compliance with Application Whitelisting solutions</h2>
    <p>
        Ideally, the tool should come inbox with operating system (or other
        product that it's intended to work with&mdash;e.g. database software.)
        Even if
        you plan to update it frequently, having the initial version inbox at
        first place (merely as a placeholder) would help
        including it into whitelisting policy. In fact, anything coming
        inbox will likely be whitelisted by default. And due to the way many
        whitelisting solutions work, that would automatically cover future 
        versions.
    </p>
    <p>
        If you cannot ship your tool inbox, that's of course understood and
        is totally fine. However, in this case you need at least to comply
        with the following publishing requirements.
    </p>
    <ol type="a">
                <li>
                    All the files that comprise the tool itself should be
                    digitally signed. (Preferably with Microsoft or other
                    recognizable vendor certificate.)<br/>
                    Please note that even WSH or PowerShell scripts can (and should)
                    be signed. Technically, a signature looks like a block
                    of text at the end of the script. Hence, the script
                    can still be distributed as a text file or embedded into
                    other, more complex structures&mdash;without invalidating
                    the signature.<br />
                    For this reason, the tool should not generate
                    or modify scripts on the fly. If you need to provide
                    variables dynamically, you can supply them as script
                    parameters. (That would also not invalidate the signature
                    of the script itself.)
                </li>
                <li>
                    If the tool comes in the form of binary executable (.exe,
                    .dll, etc.)
                    the PE header should be populated with meaningful values
                    (e.g. tool name in &ldquo;File Name&rdquo; field.) These
                    values should not be overly generic.
                </li>
                <li>
                    There should be a clear way to differentiate between
                    tool versions. Preferably, the version should be specified
                    in respective fields of PE header, or custom script heading.
                </li>
                <li>
                    The version should <b>not</b> be included into &ldquo;File
                    Name&rdquo; field (e.g. &ldquo;MyTool v.1.2.3.4&rdquo;).
                    Instead, the version should be specified in the designated
                    fields (e.g. &ldquo;File Version&rdquo;). This is because
                    every time value of &ldquo;File Name&rdquo; field is changed,
                    it is typically distinguished by whitelisting
                    mechanisms as a <b>new</b> binary. Hence such file needs to
                    be added to the policy
                    separately&mdash;which requires rebuilding and reapplying
                    the policy. And this often means a reboot.
                </li>
                <li>
                    The above requirements also apply to whatever packaging
                    mechanism is used for delivery. I.e. if the tool comes with
                    a self-extracting installer, that installer should be signed.
                    If it comes in an archive, you should use cab format or other
                    that supports embedded digital signature. (Zip format is known
                    to <b>not</b> support signatures, so it should be avoided.)
                </li>
    </ol>
    <p>
                All of the above requirements are imposed by whitelisting solutions
                such as Windows Defender Application Control (WDAC), also
                known as &ldquo;Device Guard User Mode Code Integirty&rdquo; (UMCI).
    </p>
    <p>
        If you are not familiar with WDAC, you can learn about it
        <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/windows-defender-application-control">
        here</a>. However, you don't have to become a WDAC expert. If you
        comply with the requirements listed above, you can rest assured
        that your tool does its best to comply with WDAC.<br />
    </p>        
    <blockquote>
                If you happen to ship a kernel mode driver (which is very uncommon
                for troubleshooting tools) please make sure you comply with 
                <a href="https://techcommunity.microsoft.com/t5/Windows-Hardware-Certification/Driver-compatibility-with-Device-Guard-in-Windows-10/ba-p/364865">
                HVCI requirements</a> as well.
    </blockquote>
    <p>
            The above requirements can be skipped only if the tool is a very
            simple PowerShell script which can be executed in 
            <a href="https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/">
            Constrained Language Mode</a>. If your script is fully functional 
            under constrained
            language mode, the above requirements are &ldquo;nice to
            have&rdquo;&mdash;but not strictly necessary.<br/>
    </p>
    <p>
        If you are not sure whether your script supports Constrained
        Language Mode, please do not assume it does.
    </p>

    <h2>2. Server Core support</h2>
    <p>
        The tool has to support Server Core installation option. This typically 
        means no GUI assumptions or dependencies.
    </p>
    <blockquote>
        Todo: include a link to Server Core SDK or otherwise, a list of 
        unavailable components
    </blockquote>
    <p>
        The above does not mean your tool has to be command line <b>only.</b>
        It can have a GUI as long as it's not the <b>only</b> mode of operation.
        However, all functionality should be also available in command line.
    </p>

    <h2>3. Current user credentials</h2>
    <p>
        It is very beneficial if the tool supports connecting to remote systems.
        In fact, that's one of the requirements listed below. However, you should
        not assume that fresh credentials are <b>always required</b> for that
        (or for any other operations.)
    </p>
    <p>
        There may be scenarios where current user cannot supply credentials on
        demand, especially if you prompt for user name and password and do not
        support smartcards. Some users are &ldquo;smart card only&rdquo; which
        means they have no password whatsoever. (Well, technically, they still
        do have a password&mdash;however, they do not know it.) Another somewhat
        similar scenario is Remote Credential Guard, where the user is not
        <b>supposed</b> to enter any credentials interactively, even though they
        technically can.
    </p>
    <p>
        For these reasons, the tool should always try using current user credentials
        first. (That is typically Kerberos ticket obtained from current logon
        session&mdash;however, normally you do not need to code anything special
        for this.) Only prompt for credentials optionally, or if everything else
        fails.
    </p>

    <h2>4. Internet connectivity</h2>
    <p>
        Some customers operate fully air-gapped (that is, isolated) networks.
        For this reason, the tool should not assume it always can download
        components from the Internet, or upload diagnostic data directly to
        the vendor. This behavior can be optional, and of course many customers
        would appreciate that. However, there should be also an option to supply
        all the required components (e.g. baselines, metadata, schemas, updates,
        etc.) offline, and to emit results as a set of files which can be
        transferred to the vendor manually, if needed.
    </p>

    <h2>5. External dependencies</h2>
    <p>
        Generally, the number of dependencies should be as small as possible.
        One approach to achieve that is making the tool modular. E.g. it's
        certainly helpful
        if you support gathering data using several external tools (e.g.
        Sysinternals.) But it helps if these operations are optional and can
        be omitted. Of course, running in reduced functionality will gather
        fewer data&mdash;but it might be still enough for some cases, or at least
        at the beginning. So, please do not assume you can only do &ldquo;all
        or nothing&rdquo;.
    </p>
    <p>
        The reason for this requirement is also application whitelisting. If your
        tool is a simple script, it might not need being included into the
        whitelisting policy at all. And hence it would not require policy changes.
        However, if any dependency is a binary, it will certainly require a policy
        modification. Any such occasion impose additional operational overhead
        and might slowdown or complicate troubleshooting efforts (which may be
        time-sensitive.)
    </p>
    <p>
        Even if your tool needs to be whitelisted by itself, adding fewer external
        items to the policy is often faster and easier to justify than adding a large
        number of dependencies with opaque scope.
    </p>

    <h2>6. Inbox dependencies</h2>
    <p>
        Any dependency should not be assumed as granted. It needs to be explicitly
        documented (in tool's readme, accompanying email template, etc.) This 
        even applies to dependencies on any inbox components, such as PowerShell
        modules or 32-bit subsystem (WoW64.) Even though these components are 
        included <i>by default,</i> if they can be uninstalled&mdash;there will
        be customers who remove them for one reason or another.
    </p>

    <h2>7. Remote operations</h2>
    <p>
        The tool needs to support at least one of the following. (Bonus points
        if you manage to satisfy both requirements.)
        <ol type="a">
            <li>
                Remote execution. That is, running on machine <i>A</i> while
                analyzing or configuring machines <i>B</i> and <i>C</i>.
            </li>
            <li>
                Support running in PowerShell remoting sessions. That typically
                means no interactive prompts such as &ldquo;y/n&rdquo; and no
                pop-up modal boxes (including errors or warnings.)<br/>
                This also includes uncommon cases such
                as not assuming to be able to talk to winlogon process or
                other session infrastructure or user profile artifacts. For 
                instance, it is known that if a user has never logged on
                interactively (e.g. via Remote Desktop services), the profile
                is not fully created&mdash;even though their <i>user folders</i>
                are accessible and usable upon logging on via PowerShell remoting.
                <blockquote>
                    Todo: add more technical details on what's available and
                    what's not.
                </blockquote>
                Such dependencies should be generally avoided&mdash;unless clearly
                necessary and unavoidable. (In which case requirements should be
                documented).<br />
                That said, most of existing command-line tools are known to
                operate in PowerShell remoting sessions just fine without any
                noticeable limitations.
            </li>
        </ol>
    </p>
</body>
</html>