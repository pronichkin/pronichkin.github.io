<!DOCTYPE html>
<html>
    <head>
		<title>I want to run Credential Gurad in virtual machines</title>
        <style>
            * {
                font-family: Calibri,Candara,Segoe,Segoe UI,Optima,Arial,sans-serif;
            }
        	.auto-style1 {
				height: 22px;
			}
        </style>
    </head>
    <body>
        <h1 id="top">I want to run Credential Gurad in virtual machines</h1>

        <p>
            version 2019-08-31 by <a href="/">Artem Pronichkin</a><br />
            submit a
            <a href="https://github.com/pronichkin/pronichkin.github.io/issues">
                comment
            </a> (&ldquo;issue&rdquo;) or
            <a href="https://github.com/pronichkin/pronichkin.github.io/blob/master/CredentialGuard.html">
                edit
            </a>
        </p>

        <h3>TL;DR</h3>
        <p>Good for you. You actually don't have to do anything.</p>
        <p>
            Read this again. You do not need to change any settings. Whoever told you
            have to run <i>ABC command</i> or enable <i>XYZ feature</i> was wrong.
            Please see below for popular myths and
            misconceptions
        </p>

        <div style="text-align:center">
            <blockquote class="twitter-tweet">
                <p lang="en" dir="ltr">
                    You need to enable Nested Virtualization
                    (&ldquo;ExposeVirtualizationExtensions&rdquo;) in order to have 
                    Credential Guard running inside a VM.
                </p>
                &mdash; Artem Pronichkin (@pronichkin)
                <a href="https://twitter.com/pronichkin/status/1167477209034088449?ref_src=twsrc%5Etfw">August 30, 2019</a>
            </blockquote>
            <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
        </div>

        <p>Honestly, I cannot believe how popular this myth still is!</p>

        <h3>Wait, I run VMware vSphere/KVM/XEN/etc.</h3>
        <p>
            ouch. Sorry, I cannot help you there. You need to talk to the respective
            virtualization solution vendor. I might provide some links later, but your
            favorite search engine might serve you even better.
        </p>
        <p>
            Everything below is applicable to Hyper-V, running on a modern version of
            either Windows Server or Windows 10. If you are uncertain about
            availability of a certain feature, please consult official product
            documentation or an in-depth blog post. This page is not intended to
            replace or substitute any of existing documentation. It can only provide
            an additional angle to look at the problem.
        </p>

        <h2 id="Contents">Contents</h2>
        <ul>
            <li>
                <a href="#1. Basic">1.&nbsp;Some basics</a>
                <ul>
                    <li><a href="#1.1. Credential Guard">1.1.&nbsp;Credential Guard</a></li>
                    <li><a href="#1.2. VSM">1.2.&nbsp;Virtual Secure Mode (VSM)</a></li>
                    <li><a href="#1.3. Others">1.3.&nbsp;Other technologies</a></li>
                    <li><a href="#1.4. VBS">1.4.&nbsp;What about Virtualization-Based Security (VBS)?</a></li>
                </ul>
            </li>
            <li>
                <a href="#2. Myth">2.&nbsp;Myths and Misconceptions</a>
                <ul>
                    <li><a href="#2.1. IUM">2.1.&nbsp;I need to enable the &ldquo;Isolated user mode&rdquo; feature</a></li>
                    <li><a href="#2.2. Hypervisor">2.2.&nbsp;I need to install hypervisor inside virtual machine</a></li>
                    <li><a href="#2.3. Nested">2.3.&nbsp;I need to enable Nested Virtualization for a virtual machine</a></li>
                    <li><a href="#2.4. Extension">2.4.&nbsp;I need to configure VM to &ldquo;Expose Virtualization Extensions&rdquo;</a></li>
                    <li><a href="#2.5. Dynamic">2.5.&nbsp;I need to disable Dynamic Memory</a></li>
                    <li><a href="#2.6. DMA">2.6.&nbsp;I need to disable DMA protection</a></li>
                    <li><a href="#2.7. TPM">2.7.&nbsp;I need to enable virtual TPM</a></li>
                    <li><a href="#2.8. Shielded">2.8.&nbsp;I need Shielded Virtual Machine</a></li>
                    <li><a href="#2.9. Encryption">2.9.&nbsp;I need Encryption-supported virtual machine</a></li>
                </ul>
            </li>
            <li>
                <a href="#3. Truth">3.&nbsp;What you actually need</a>
                <ul>
                    <li><a href="#3.1. Secure">3.1.&nbsp;UEFI Secure Boot</a></li>
                    <li><a href="#3.2. Generation">3.2.&nbsp;Generation 2 Virtual Machine</a></li>
                    <li><a href="#3.3. Guest VSM">3.3.&nbsp;Guest Virtual Secure Mode (Guest VSM)</a></li>
                </ul>
            </li>
        </ul>

        <h2 id="1. Basic">1.&nbsp;Some basics</h2>
        <p>
            Before diving into details, we need to make sure we&apos;re on the same
            page.
        </p>

        <h3 id="1.1. Credential Guard">1.1.&nbsp;Credential Guard</h3>
        <p>
            We&apos;re primarily talking about Credential Guard here because that&apos;s
            what everyone seems to be obsessed with. Everyone have read about
            Mimikatz (or seen some cool demo) and believe they need Credential Guard.
            Well, who am I to disagree. However, out of this need, people seem to 
            drive all sorts of false assumptions and unnecessary requirements. This 
            becomes particularly noticeable when we start talking about virtual 
            machines. Nowadays it seems that pretty much everyone have finally 
            understood the prerequisites to run Credential Guard on bare metal (that 
            is, on physical computers.) But when we add virtualization to the picture,
            everyone suddenly becomes utterly confused. So, we&apos;re here to debunk 
            at least some of that confusion.
        </p>
        <p>
            <a href="#top">back to top</a>
        </p>

        <h3 id="1.2. VSM">1.2.&nbsp;Virtual Secure Mode (VSM)</h3>
        <p>
            That's the actual technology that powers Credential Guard. Credential
            Guard fully depends on Virtual Secure Mode. The very problem of
            understanding and satisfying the requirements of Credential Guard (be it
            on a physical or virtual machine) is actually the problem of understanding
            and satisfying the requirements of running Virtual Secure Mode. Throughout
            this document, we keep saying &ldquo;Credential Guard&rdquo; because
            that&apos;s what everyone is concerned about (and we understand that&apos;s
            the end goal.) However, what we are actually talking about is enabling
            Virtual Secure Mode.
        </p>
        <p>
            <a href="#top">back to top</a>
        </p>

        <h3 id="1.3. Others">1.3.&nbsp;Other technologies</h3>
        <p>
            In fact, there is a bunch of other security technologies in Windows that
            are independent from Credential Guard but similarly to it depend on
            Virtual Secure Mode. For example:
        </p>

        <ul>
            <li>Windows Defender Application Control (WDAC), also known as Device
                Guard Code Integrity;</li>
            <li>Hypervisor-enforced Code Integrity (HVCI) which is amusingly not the
            same as &ldquo;regular&rdquo; Code Integrity now known as WDAC;</li>
            <li>Shielded VMs (they rely on Virtual Secure Mode on the host as 
            explained <a href="#2.8. Shielded">below</a>)</li>
            <li>SQL Server Always Encrypted with
            <a href="https://docs.microsoft.com/en-us/sql/relational-databases/security/encryption/always-encrypted-enclaves">Secure
            Enclaves</a></li>
        </ul>
        <p>
            Virtual Secure Mode is designed as an extensible infrastructure, where
            additional features can be plugged in as so-called
            &ldquo;<a href="https://docs.microsoft.com/en-us/windows/win32/procthread/isolated-user-mode--ium--processes#trustlets">trustlets</a>&rdquo;.
            Hence, expect more and more features to be
            introduced over time with dependencies on Virtual Secure Mode&mdash;both
            in Windows and other software (such as SQL Server.)
        </p>
        <p>
            All of such features would share the same requirements that are actually
            prerequisites to run Virtual Secure Mode. Hence, the below
            discussion applies entirely to any of such features. Just replace
            &ldquo;Credential Guard&rdquo; with the name of the feature you&apos;re 
            concerned about&mdash;and keep reading.
        </p>
        <p>
            <a href="#top">back to top</a>
        </p>

        <h3 id="1.4. VBS">1.4.&nbsp;What about Virtualization-Based Security (VBS)?</h3>
        <p>
            That's simply another name for Virtual Secure Mode. Exactly the same
            thing, just slightly different accent. &ldquo;Virtual Secure Mode&rdquo;
            (VSM) is a Windows feature name, while &ldquo;Virtualization-Based
            Security&rdquo; (VBS) is more like a generic industry term. But for the
            context of this (and many others) document these terms mean exactly the
            same and are completely interchangeable.
        </p>
        <p>
            Do not get confused. We prefer to say &ldquo;Virtual Secure Mode&rdquo;
            but you can use whatever name you please. Moreover, VSM sounds less
            ambiguous than VBS.
        </p>
        <p>
            <a href="#top">back to top</a>
        </p>

        <h2 id="2. Myth">2.&nbsp;Myths and Misconceptions</h2>
        <h3 id="2.1. IUM">2.1.&nbsp;I need to enable the &ldquo;Isolated user mode&rdquo; feature</h3>
        <p>
            No. That was true very long ago, for early versions of Windows 10. (Namely,
            versions 1507 and 1511.) Starting with Windows 10, version 1607, that&apos;s
            no longer true.
        </p>
        <p>You might also know version 1607 under one of the following names:</p>
        <ul>
            <li>Windows 10 Enterprise 2016 LTSC/LTSB</li>
            <li>Windows Server 2016</li>
        </ul>
        <p>
            None of these, or later versions of Windows require any optional features
            or components to be installed.
        </p>
        <p>
            <a href="#top">back to top</a>
        </p>

        <h3 id="2.2. Hypervisor">2.2.&nbsp;I need to install hypervisor inside virtual machine</h3>
        <p>
            There are multiple hypervisor-related features you might find in
            &ldquo;Windows Features&rdquo; window (.\OptionalFeatures.exe).
        </p>

        <blockquote>
            <table border="1"
				style="border-collapse: collapse; border-spacing: 0; padding:5px;" >
                <tr>
                    <th style="padding: 5px">Display Name<br />(used in &ldquo;Windows Features&rdquo;)</th>
                    <th style="padding: 5px">Internal Name<br />(used in DISM or PowerShell)</th>
                    <th style="padding: 5px">Comment</th>
                </tr>
                <tr>
                    <td style="padding: 5px">Hyper-V</td>
                    <td style="padding: 5px">Microsoft-Hyper-V-All</td>
                    <td style="padding: 5px">
                        Parent feature for &ldquo;Hyper-V Management Tools&rdquo; and
                        &ldquo;Hyper-V Platform&rdquo;
                    </td>
                </tr>
                <tr>
                    <td style="padding: 5px">Hyper-V Platform</td>
                    <td style="padding: 5px">Microsoft-Hyper-V</td>
                    <td style="padding: 5px">
                        Parent feature for &ldquo;Hyper-V Hypervisor&rdquo; and
                        &ldquo;Hyper-V Services&rdquo;
                    </td>
                </tr>
                <tr>
                    <td style="padding: 5px">Hyper-V Hypervisor</td>
                    <td style="padding: 5px">Microsoft-Hyper-V-Hypervisor</td>
                    <td style="padding: 5px">Actual hypervisor</td>
                </tr>
                <tr>
                    <td style="padding: 5px">Virtual Machine Platform</td>
                    <td style="padding: 5px">VirtualMachinePlatform</td>
                    <td style="padding: 5px">
                        Hypervisor component without management layer. Required for
                        non-Hyper-V features like HVSI (not to be confused with HVCI),
                        Containers, WSL2 or Windows Defender
                        Application Guard, WDAG (not to be confused with WDAC)
                    </td>
                </tr>
                <tr>
                    <td style="padding: 5px">Windows Hypervisor Platform</td>
                    <td style="padding: 5px">HypervisorPlatform</td>
                    <td style="padding: 5px">
                        Also known as &ldquo;WHPX&rdquo;. Allows 3<sup>rd</sup> party 
                        virtualization software (e.g. Qemu, VirtualBox, Android 
                        emulator, and soon VMware Workstation) to leverage Windows 
                        hypervisor in place of their own (while maintaining their own
                        services and management layer), and hence coexist with 
                        other features that 
                        depend on it, such as VSM
                    </td>
                </tr>
                <tr>
                    <td style="padding: 5px">Isolated User Mode</td>
                    <td style="padding: 5px">IsolatedUserMode</td>
                    <td style="padding: 5px">
                        Legacy feature used in older versions of Windows 10
                        (<a href="#2.1. IUM">see above</a>). Not available
                        or needed anymore
                    </td>
                </tr>
            </table>
        </blockquote>

        <p>
            The funny thing is, all of the above features leverage Windows hypervisor,
            one way or another. But this plethora of options and their taxonomy
            might be highly confusing&mdash;and boy it is! (To make the list shorter
            and hence <i>slightly</i> less confusing, the above table does not include
            Hyper-V management features. The names of their respective components are
            pretty self-explanatory.)
        </p>
        <p>
            Good news, however, is that you do not have to manually enable or configure
            <i>any</i> of them! If you see any guidance that tells that you need to
            enable any of these features (either manually or via script), that
            guidance is significantly outdated. It was authored for some very
            old version of Windows which is likely out of support already. If you are
            using that version of Windows, you have bigger problems to solve than
            enabling Credential Guard. Good luck!
        </p>
        <p>
            <a href="#top">back to top</a>
        </p>

        <h3 id="2.3. Nested">2.3.&nbsp;I need to enable Nested Virtualization for a virtual machine</h3>
        <p>
            That&apos;s not true. Nested virtualization is required if you need to run
            actual hypervisor inside a virtual machine. As per the previous chapter,
            you do not need to run hypervisor if all you need is Credential Guard.
        </p>
        <p>
            Please read this again. You do not need to enable <b>any</b> optional
            features inside a virtual machine if your end goal is to run Credential
            Guard.
        </p>
        <p>
            <a href="#top">back to top</a>
        </p>

        <h3 id="2.4. Extension">2.4.&nbsp;I need to configure VM to &ldquo;Expose Virtualization Extensions&rdquo;</h3>
        <p>
            You are talking about this PowerShell command:
        </p>
        <blockquote style="background-color:blue; color: white; font-family: Consolas,monaco,monospace;">
            &nbsp;Set-vmProcessor -vm $vm -ExposeVirtualizationExtensions $True
        </blockquote>
        <p>
            This command enables Nested Virtualization. You do not need to do that.
            Please see the previous section.
        </p>
        <p>
            <a href="#top">back to top</a>
        </p>

        <h3 id="2.5. Dynamic">2.5.&nbsp;I need to disable Dynamic Memory</h3>
        <p>
            This is a known prerequisite to enable Nested Virtualization. While not
            strictly required, it's advisable to disable Dynamic Memory if you intend
            to use Nested Virtualization. (More details
            <a href="https://docs.microsoft.com/en-us/virtualization/hyper-v-on-windows/user-guide/nested-virtualization#dynamic-memory-and-runtime-memory-resize">here</a>.)
            Note that it used to be a strict prerequisite for Nested Virtualization
            in some preview builds.
        </p>
        <p>
            However, you are not going to use Nested Virtualization. So, this
            recommendation does not apply. If you think you need Nested Virutalization
            please see above.
        </p>
        <p>
            <a href="#top">back to top</a>
        </p>

        <h3 id="2.6. DMA">2.6.&nbsp;I need to disable DMA protection</h3>
        <p>
            This is yet another known requirement related to Nested Virtualization.
            It applies to scenarios where all of the following is true.
        </p>
        <ul>
            <li>You enable Nested Virtualization</li>
            <li>You run a hypervisor inside virtual machine</li>
            <li>
                You <i>also</i> need to run Virtual Secure Mode (VSM) in the same
                VM
            </li>
        </ul>
        <p>
            As a reminder, there may be various reasons to run VMS inside a VM.
            Credential Guard is one of them. However, if you only need Credential
            Guard, you do not have to enable Nested Virtualization. Hence, this
            limitation does not apply to you.
        </p>
        <p>
            The most common scenario where all of the above conditions are valid is
            running so-called &ldquo;Guarded Host&rdquo; inside a VM, e.g. for a
            Shielded VMs lab. Shielded VMs technology relies on VSM on a host
            (and such host is called Guarded Host.) If such host is actually a VM
            itself, you end up in this scenario.
        </p>
        <p>
            Another less common use case where the same limitation applies is scenario
            known as &ldquo;Repair Garage&rdquo; used in Shielded VMs implementation.
            It is different from the abovementioned lab scenario in the sense that the
            only Shielded VM is the &ldquo;Garage&rdquo; itself, running in a
            hypervisor which runs on bare metal. The &ldquo;nested&rdquo; VMs are not
            necessarily shielded. However, since this scenario still involve nested
            virtualization, it falls into the same bucket.
        </p>
        <p>
            In this case, VSM cannot cannot benefit from DMA protection. The reason
            is that Hyper-V does not provide a virtual device with IOMMU functionality
            (which is similar to Intel Virtualization Technology for Directed I/O or
            VT-d.)
        </p>
        <p>
            So, if you configure Virtual Secure Mode in such scenarios, you should
            not configure it to require DMA protection. In other words, the value of
            &ldquo;RequirePlatformSecurityFeatures&rdquo; parameter should be <b>1</b>
            and not <b>3</b>.
        </p>
        <p>
            If you are curious what are the meanings of different numerical values of
            &ldquo;RequirePlatformSecurityFeatures&rdquo;, they <i>seem</i> to
            correspond to &ldquo;<a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/device-guard/enable-virtualization-based-protection-of-code-integrity#requiredsecurityproperties">RequiredSecurityProperties</a>&rdquo; in
            &ldquo;Win32_DeviceGuard&rdquo; WMI class. However, the only officially
            documented values are <b>1</b> and <b>3</b>.
        </p>
        <p>
            Anyhow, if you do not intend to run virtual machines (shielded or
            otherwise) inside your virtual machine, you do not need nested
            virtualization feature. As such, the DMA Protection limitation does not
            apply to your scenario. You can safely require DMA Protection, i.e. set
            &ldquo;RequirePlatformSecurityFeatures&rdquo; to <b>3</b>.
        </p>
        <p>
            However, if you indeed aim to use Nested Virtualization, and hence relax
            the DMA Protection requirement, please be aware that you are trading off
            a valuable security feature. This is one of the reasons this scenario
            is intended for running Shielded VMs in a lab and not a real production
            deployment.
        </p>
        <p>
            <a href="#top">back to top</a>
        </p>

        <h3 id="2.7. TPM">2.7.&nbsp;I need to enable virtual TPM</h3>
        <p>
            Well this assumption is not as false as previous ones. However, it is
            still false. In fact,
            <a href="https://docs.microsoft.com/en-us/windows/security/information-protection/tpm/tpm-recommendations#tpm-and-windows-features">you do not need a TPM</a>
            to run Credential Guard. This is true for both physical (bare metal) and
            virtual machines.
        </p>
        <p>
            However, TPM is highly recommended. As
            <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/credential-guard/credential-guard-requirements#baseline-protections">documentation</a>
            says, &ldquo;A TPM provides protection for VBS encryption keys that are
            stored in the firmware. This helps protect against attacks involving a
            physically present user with BIOS access.&rdquo;
        </p>
        <p>
            <a href="#top">back to top</a>
        </p>

        <h3 id="2.8. Shielded">2.8.&nbsp;I need Shielded Virtual Machine</h3>
        <p>
            To put it simply, you don&apos;t. There are no technical requirement to
            have any of Shielded VMs features if you want to run Credential Guard or
            any other feature powered by Virtual Secure Mode (e.g. HVCI.)
        </p>
        <p>
            However, let&apos;s talk about threat modeling a little. As explained
            above, having a TPM is <i>strongly advised</i>. Without a TPM, your
            machine (or everything protected by VSM insde a machine) is vulnerable
            for attacks by anyone with physical access. For a bare-metal machine,
            that's anyone nearby your computer. But for a virtual machine, that's
            anyone nearby your virtualization host, and not only. That might also
            include anyone <i>remote</i> with administrative access to the
            virtualization host (e.g. your virtualization administrator), or anyone
            with access to virtual machine <i>files</i> one way or another. In some
            environments that might include the storage (SAN) administrator, backup
            operator, network administrator, datacenter technicians&mdash;or even the
            hardware vendor who swaps bad parts in servers.
        </p>
        <p>
            What I'm trying to say here, the concept of &ldquo;physical access&rdquo;
            is very different list if you compare that with a physical server. For a
            virtual machine, &ldquo;physical access&rdquo; is&hellip; well, virtual.
        </p>
        <p>
            So, looking at the above recommendation again, we should add a TPM to
            mitigate this attack vector. Is that it? Well, yes, if we were talking
            about a physical machine. But with a virtual machine, that list of people
            who have an equivalent of &ldquo;physical access&rdquo; might be endless.
        </p>
        <p>
            Simply adding a virtual TPM does not add anything to our threat model.
            Now instead of protecting the VM disk files, we need to protect much
            smaller configuration file (or wherever the contents of virtual TPM
            lives.) Even though virtual TPM contents is always encrypted at rest, the
            encryption key has to be stored somewhere. And by default there's nowhere
            else to store it other than the host itself. Which means it is still
            perfectly accessible to anyone with host access.
        </p>
        <p>
            Yes, the purpose of Credential Guard is to protect from attacks from
            within the same operating system (e.g. malicious processes.) In this
            sense, if your threat model only assumes attacks from within the virtual
            machine, having a TPM would address that. But if you also consider attack
            at the host level (e.g. malicious or careless administrator), you&apos;re
            not done yet.
        </p>
        <p>
            Addressing this specific attack vector is not easy at all. Turns out, to
            do that comprehensively, you need a whole bunch of new things.
        </p>
        <ul>
            <li>
                Offload key protection to an external authority which is not
                controlled or accessible by virtualization host (&ldquo;Fabric&rdquo;)
                administrators.
            </li>
            <li>
                A mechanism to ensure that keys can only be decrypted by predefined
                list of known such authorities.
            </li>
            <li>
                Because hosts still need access to the key when turning on the VMs or
                accepting incoming live migrations, implement a mechanism of
                delivering said key to the host and storing it host&apos;s secure
                area (which is also based on Virtual Secure Mode.)
            </li>
            <li>
                Set up a comprehensive set of technical protections that prevent
                host administrators from accessing the keys or decrypted material
                while VMs are running. That includes regular features protecting VSM,
                such as DMA protection, as well as additional safeguards&mdash;such
                as preventing debuggers, memory dump encryption, application
                whitelisting (Device Guard Code Integrity or Windows Defender
                Application Control, WDAC), etc.
            </li>
            <li>
                A known good set (baseline) of host configuration including all of the
                above protections.
            </li>
            <li>
                A mechanism to check (attest) a given host against the defined
                baseline.
            </li>
            <li>
                A mechanism to ensure that key delivery only happens when a host
                passes attestation.
            </li>
            <li>
                A framework to enforce protections on VM level (policy), so that
                security properties are embedded into VM configuration and cannot be
                arbitrarily changed by whoever has access to the host or storage.
            </li>
            <li>
                A mechanism to ensure that policy applies automatically to all new VMs
                created by (or on behalf of) specific owner.
            </li>
            <li>
                A mechanism to ensure that only known good media (&ldquo;Clean
                Source&rdquo;) is used to provision a virtual machine. (Otherwise
                an administrator or malware running at Fabric level could poison a VM
                before it&apos;s even created.)
            </li>
            <li>
                A mechanism to deliver VM specialization data (e.g. domain join
                credentials or certificates) during provisioning in a secure manner
                so that host administrators cannot sniff or tamper with it. Otherwise,
                there's no way to ensure that VM popped on the network is the actual
                VM you provisioned (e.g. prevent MitM attack.)
            </li>
            <li>
                Probably other things which are less important or which I forgot of.
            </li>
        </ul>

        <p>
            Shielded VMs <i>solution</i> address precisely the concerns above, so that
            you can be confident that your secrets&mdash;while protected by Credential
            Guard in the Guest&mdash;are immune to &ldquo;physical
            presence&rdquo;-equivalent attacks at the host.
        </p>
        <p>
            Finally, it&apos;s worth mentioning that &ldquo;Shielded VMs&rdquo; term
            is a bit overloaded. Having a VM &ldquo;Shielded&rdquo; by ticking a
            checkbox in Hyper-V management interface will not magically deliver on
            the security promise explained above. From the list of features above it
            should be obvious that they work closely together and depend on one
            another. Having only some parts of the solution will not help you much,
            if ever. So, if you are interested in this comprehensive set of
            protections you need to implement the whole Shielded VMs <i>solution</i>,
            or infrastructure. That might include both technical features (e.g. Host
            Guardian Service or HGS) and organizational changes. The very purpose
            of the Shielded VMs solution is <i>role separation</i> and you cannot
            technically enforce it if there are no separate roles in your processes.
        </p>
        <p>
            However, believe it or not, but planning a Shielded VMs implementation is
            not the topic of this document. As such, let&apos;s get back to answering
            the original question.
        </p>

        <p>
            No, you do not need Shielded VMs for running
            Credential Guard in the VMs. However, if your threat model includes not
            only guest-based, but also host-based attack vectors (which is an
            equivalent of &ldquo;physical access&rdquo; for virtual machines) you
            definitely should implement the full Shielded VMs solution.
        </p>
        <p>
            <a href="#top">back to top</a>
        </p>

        <h3 id="2.9. Encryption">2.9.&nbsp;I need Encryption-supported virtual machine</h3>
        <p>
            Encryption-supported VMs is a subset of Shielded VMs functionality. Or,
            put it slightly different, it&apos;s an alternative <i>security policy</i>
            option for virtual machines, on par with Shielded.
        </p>
        <p>
            As such, it relies on all the same infrastructure as full Shielded VMs
            solution. Just as with Shielded VMs, you cannot have Encryption Supported
            VMs without deploying the full solution.
        </p>
        <p>
            However, Encryption supported VMs provide slightly more
            convenience&mdash;both for virtual machine owner (tenant) and host
            (&ldquo;Fabric&rdquo;) administrator. As such, it might be a viable
            alternative to Shielded VMs.
        </p>
        <p>
            To reiterate, if your end goal is to run Credential Guard, you do not need
            Encryption Supported VMs&mdash;just as you don&apos;t need Shielded VMs
            either.
        </p>
        <p>
            However, if your threat model assumes host-based
            attack vectors, and you are looking at Shielded VMs to address those,
            you can consider Encryption-supported VMs. But you
            will need to carefully assess different available policy options and
            validate them against your threat model before
            deciding between Shielded or Encryption-supported.
        </p>
        <p>
            <a href="#top">back to top</a>
        </p>

        <h2 id="3. Truth">3.&nbsp;What you actually need</h2>
        <p>
            As I said multiple times already, you don&apos;t need to do
            <i>anything.</i> However, I knew you won&apos;t simply believe me, so here
            are some details.
        </p>

        <h3 id="3.1. Secure">3.1.&nbsp;UEFI Secure Boot</h3>
        <p>
            This is one of unavoidable requirements of Virtual Secure Mode, and hence
            Credential Guard. However, it's enabled by default for all Generation 2
            virtual machines.
        </p>
        <p>
            <a href="#top">back to top</a>
        </p>

        <h3 id="3.2. Generation">3.2.&nbsp;Generation 2 Virtual Machine</h3>
        <p>
            Secure Boot is only available for Generation 2 virtual machines.
        </p>
        <p>
            Please do not abbreviate &ldquo;Generation 2&rdquo; as &ldquo;Gen2&rdquo;.
            This sounds wrong. I mean, Microsoft loves Linux. But not up to the point
            of making our features <i>sound</i> indistinguishable from names of
            popular Linux distributions. Unless you&apos;re sending a telegram and
            hence have to pay by letter, please use full name: &ldquo;Generation
            2&rdquo;. Trust me, it does not hurt to type a little more.
        </p>
        <p>
            <a href="#top">back to top</a>
        </p>

        <h3 id="3.3. Guest VSM">3.3.&nbsp;Guest Virtual Secure Mode (Guest VSM)</h3>
        <p>
            This is a feature that actually allows you to run Virtual Secure Mode
            without having a hypervisor running inside virtual machine. Instead, it
            provides the required isolation services from the host (while not
            compromising security.)
        </p>
        <p>
            Similarly to Secure Boot, this feature is enabled for all Generation 2
            virtual machines. You do not have do anything about it. That's the whole
            point of this document.
        </p>
        <p>
            However, you can <i>disable</i> this feature if you want (e.g. for
            testing, or when using some other feature which seems to be incompatible.)
        </p>

        <blockquote style="background-color:blue; color: white; font-family: Consolas,monaco,monospace;">
            &nbsp;Set-vmSecurity -vm $vm -VirtualizationBasedSecurityOptOut $True
        </blockquote>

        <p>
            Yes, to <i>disable</i> a feature, you need to <i>enable</i> a setting
            that <i>opts out</i> this feature. So PowerShell, much intuitive, wow.
            Don&apos;t ask me.
        </p>
        <p>
            <a href="#top">back to top</a>
        </p>
    </body>
</html>